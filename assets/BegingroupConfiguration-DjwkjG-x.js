import{f as p,D as m,P as d,b,E as R,e as u,H as i,B as f,C as I,a as g}from"./index-qNrukWGA.js";import{N as l,a as o}from"./NewcommandUtil-D3UYa-Vw.js";import"./index-DkSxGWYw.js";class t{constructor(a){this.i=l,this.top=l,this.base=l,this.MARKER=Symbol("marker"),this.handlers=a.handlers,this.getGlobal()}getGlobal(){this.global={[o.NEW_DELIMITER]:p.getMap(o.NEW_DELIMITER),[o.NEW_ENVIRONMENT]:p.getMap(o.NEW_ENVIRONMENT),[o.NEW_COMMAND]:p.getMap(o.NEW_COMMAND)}}checkGlobal(a,E){for(const s of E){const h=a.shift(),c=this.handlers.get(t.handlerMap[s]);this.global[s].add(h,this.MARKER);let N;do{const M=c.applicable(h);N=M.lookup(h),M.remove(h)}while(N&&N!==this.MARKER)}return E.map(s=>this.global[s])}push(){new m(o.NEW_DELIMITER,d.delimiter,{}),new b(o.NEW_COMMAND,{}),new R(o.NEW_ENVIRONMENT,d.environment,{}),this.handlers.add(t.handlerConfig,{},--this.i)}pop(){if(this.i===this.base)throw new u("MissingBegingroup","Missing \\begingroup or extra \\endgroup");this.handlers.remove(t.handlerConfig,{});for(const a of[o.NEW_COMMAND,o.NEW_ENVIRONMENT,o.NEW_DELIMITER])p.register(this.handlers.retrieve(a));this.i++}finish(){this.top=this.i}remove(){for(;this.i<this.top;)this.pop()}reset(){this.top=this.base,this.remove()}sandbox(){this.base=l,this.reset(),this.push(),this.getGlobal(),this.base=l-1}}t.handlerConfig={[i.DELIMITER]:[o.NEW_DELIMITER],[i.ENVIRONMENT]:[o.NEW_ENVIRONMENT],[i.MACRO]:[o.NEW_DELIMITER,o.NEW_COMMAND]};t.handlerMap={[o.NEW_DELIMITER]:i.DELIMITER,[o.NEW_ENVIRONMENT]:i.ENVIRONMENT,[o.NEW_COMMAND]:i.MACRO};function r(e){return e.packageData.get("begingroup").stack}const n={begingroup(e,a){r(e.configuration).push()},endgroup(e,a){r(e.configuration).pop()},reset(e,a){r(e.configuration).reset()},sandbox(e,a){r(e.configuration).sandbox(),e.stack.global.isSandbox=!0},global(e,a){const E=e.i,s=e.GetNext()==="\\"?(e.i++,e.GetCS()):"";if(e.i=E,!e.options.begingroup.allowGlobal.includes(s))throw new u("IllegalGlobal","Invalid use of %1",e.currentCS);e.stack.env.isGlobal=!0},macro:f.Macro};new b("begingroup",{begingroup:n.begingroup,endgroup:n.endgroup,global:n.global,gdef:[n.macro,"\\global\\def"],begingroupReset:n.reset,begingroupSandbox:n.sandbox});new b("begingroup",{begingroup:n.begingroup,endgroup:n.endgroup,global:n.global,gdef:[n.macro,"\\global\\def"],begingroupReset:n.reset,begingroupSandbox:n.sandbox});const _=I.create("begingroup",{[g.HANDLER]:{[i.MACRO]:["begingroup"]},[g.CONFIG]:(e,a)=>{a.parseOptions.packageData.set("begingroup",{stack:new t(a.parseOptions)})},[g.OPTIONS]:{begingroup:{allowGlobal:["let","def","newcommand","DeclareMathOperator","Newextarrow"]}},[g.PREPROCESSORS]:[({data:e})=>r(e).remove()],[g.POSTPROCESSORS]:[({data:e})=>r(e).finish()]});export{_ as BegingroupConfiguration};
