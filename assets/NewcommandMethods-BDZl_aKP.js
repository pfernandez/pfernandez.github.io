import{i as b,e as h,B as E,j as d,H as m,M as G,d as k,D as A,U as N}from"./index-qNrukWGA.js";import{b as e}from"./NewcommandUtil-D3UYa-Vw.js";class y extends b{get kind(){return"beginEnv"}get isOpen(){return!0}checkItem(n){if(n.isKind("end")){if(n.getName()!==this.getName())throw new h("EnvBadEnd","\\begin{%1} ended with \\end{%2}",this.getName(),n.getName());return[[this.factory.create("mml",this.toMml())],!0]}if(n.isKind("stop"))throw new h("EnvMissingEnd","Missing \\end{%1}",this.getName());return super.checkItem(n)}}const a={NewCommand(t,n){const i=e.GetCsNameArgument(t,n),o=e.GetArgCount(t,n),c=t.GetBrackets(n),u=t.GetArgument(n);e.addMacro(t,i,a.Macro,[u,o,c]),t.Push(t.itemFactory.create("null"))},NewEnvironment(t,n){const i=N.trimSpaces(t.GetArgument(n)),o=e.GetArgCount(t,n),c=t.GetBrackets(n),u=t.GetArgument(n),g=t.GetArgument(n);e.addEnvironment(t,i,a.BeginEnv,[!0,u,g,o,c]),t.Push(t.itemFactory.create("null"))},MacroDef(t,n){const i=e.GetCSname(t,n),o=e.GetTemplate(t,n,"\\"+i),c=t.GetArgument(n);o instanceof Array?e.addMacro(t,i,a.MacroWithTemplate,[c].concat(o)):e.addMacro(t,i,a.Macro,[c,o]),t.Push(t.itemFactory.create("null"))},Let(t,n){const i=e.GetCSname(t,n);let o=t.GetNext();o==="="&&(t.i++,o=t.GetNext());const c=t.configuration.handlers;if(t.Push(t.itemFactory.create("null")),o==="\\"){if(n=e.GetCSname(t,n),i===n)return;const g=c.get(m.MACRO).applicable(n);if(g instanceof G){const s=g.lookup(n);e.addMacro(t,i,s.func,s.args,s.token);return}if(g instanceof k&&!(g instanceof A)){const s=g.lookup(n),f=M=>g.parser(M,s);e.addMacro(t,i,f,[i,s.char]);return}const l=c.get(m.DELIMITER).lookup("\\"+n);if(l){e.addDelimiter(t,"\\"+i,l.char,l.attributes);return}e.checkProtectedMacros(t,i),e.undefineMacro(t,i),e.undefineDelimiter(t,"\\"+i);return}t.i++;const u=c.get(m.DELIMITER).lookup(o);if(u){e.addDelimiter(t,"\\"+i,u.char,u.attributes);return}e.addMacro(t,i,a.Macro,[o])},MacroWithTemplate(t,n,i,o,...c){const u=parseInt(o,10);if(c.length){const g=[];if(t.GetNext(),c[0]&&!e.MatchParam(t,c[0]))throw new h("MismatchUseDef","Use of %1 doesn't match its definition",n);if(u){for(let l=0;l<u;l++)g.push(e.GetParameter(t,n,c[l+1]));i=d.substituteArgs(t,g,i)}}t.string=d.addArgs(t,i,t.string.slice(t.i)),t.i=0,d.checkMaxMacros(t)},BeginEnv(t,n,i,o,c,u){const g=n.getName();if(t.stack.env.closing===g){if(delete t.stack.env.closing,t.stack.global.beginEnv&&(t.stack.global.beginEnv--,o)){const s=t.string.slice(t.i);t.string=d.addArgs(t,t.string.substring(0,t.i),o),t.Parse(),t.string=s,t.i=0}return t.itemFactory.create("end").setProperty("name",g)}if(c){const l=[];if(u!=null){const s=t.GetBrackets(`\\begin{${g}}`);l.push(s??u)}for(let s=l.length;s<c;s++)l.push(t.GetArgument(`\\begin{${g}}`));i=d.substituteArgs(t,l,i),o=d.substituteArgs(t,[],o)}return t.string=d.addArgs(t,i,t.string.slice(t.i)),t.i=0,t.stack.global.beginEnv=(t.stack.global.beginEnv||0)+1,t.itemFactory.create("beginEnv").setProperty("name",g)},Macro:E.Macro};export{y as B,a as N};
